mqtt:
  sensor:
    - name: "SmartMeter MAC Address"
      state_topic: "dsmr/smart_gateways/mac_address"
    - name: "SmartMeter firmware running version"
      state_topic: "dsmr/smart_gateways/running_firmware_version"
    - name: "SmartMeter firmware available version"
      state_topic: "dsmr/smart_gateways/available_firmware_version"
    - name: "SmartMeter firmware update available"
      state_topic: "dsmr/smart_gateways/update_available"
    - name: "SmartMeter wifi signal strength (rssi)"
      state_topic: "dsmr/smart_gateways/wifi_rssi"
      unit_of_measurement: "dB"
    - name: "SmartMeter startup time"
      state_topic: "dsmr/smart_gateways/startup_time"
      device_class: timestamp
      icon: mdi:clock-start
    - name: "SmartMeter IP Address"
      state_topic: "dsmr/smart_gateways/ip_address"
    - name: "SmartMeter WaterDelivered"
      state_topic: "dsmr/consumption/water/delivered"
      unit_of_measurement: "L"
  switch:
    - name: "SmartMeter Install firmware update?"
      command_topic: "dsmr/smart_gateways/install_update"
      payload_on: "yes"
      payload_off: "no"

### Enable SmartGateways.nl SmartMeter Gateway - utility meter
utility_meter:
  gasusage_this_hour:
    name: "Gas usage (hourly)"
    unique_id: gas_usage_hourly
    source: sensor.dsmr_consumption_gas_delivered
    cycle: hourly
  gasusage_today:
    name: "Gas usage (daily)"
    unique_id: gas_usage_daily
    source: sensor.dsmr_consumption_gas_delivered
    cycle: daily
  gasusage_this_week:
    name: "Gas usage (weekly)"
    unique_id: gas_usage_weekly
    source: sensor.dsmr_consumption_gas_delivered
    cycle: weekly
  gasusage_this_month:
    name: "Gas usage (monthly)"
    unique_id: gas_usage_monthly
    source: sensor.dsmr_consumption_gas_delivered
    cycle: monthly
  gasusage_this_quarter:
    name: "Gas usage (quarterly)"
    unique_id: gas_usage_quarterly
    source: sensor.dsmr_consumption_gas_delivered
    cycle: quarterly
  gasusage_this_year:
    name: "Gas usage (yearly)"
    unique_id: gas_usage_yearly
    source: sensor.dsmr_consumption_gas_delivered
    cycle: yearly



  hourly_energy_delivered_offpeak:
    name: "Energy usage offpeak (hourly)"
    unique_id: energy_usage_offpeak_hourly
    source: sensor.dsmr_reading_electricity_delivered_1
    cycle: hourly
  hourly_energy_delivered_peak:
    name: "Energy usage peak (hourly)"
    unique_id: energy_usage_peak_hourly
    source: sensor.dsmr_reading_electricity_delivered_2
    cycle: hourly

  hourly_energy_returned_offpeak:
    name: "Energy return offpeak (hourly)"
    unique_id: energy_return_offpeak_hourly
    source: sensor.dsmr_reading_electricity_returned_1
    cycle: hourly
  hourly_energy_returned_peak:
    name: "Energy return peak (hourly)"
    unique_id: energy_return_peak_hourly
    source: sensor.dsmr_reading_electricity_returned_2
    cycle: hourly

  # Berekening van dagwaarden voor electriciteit hoog- en laagtarief
  daily_energy_delivered_offpeak:
    name: "Energy usage offpeak (daily)"
    unique_id: energy_usage_offpeak_daily
    source: sensor.dsmr_reading_electricity_delivered_1
    cycle: daily
  daily_energy_delivered_peak:
    name: "Energy usage peak (daily)"
    unique_id: energy_usage_peak_daily
    source: sensor.dsmr_reading_electricity_delivered_2
    cycle: daily

  daily_energy_returned_offpeak:
    name: "Energy return offpeak (daily)"
    unique_id: energy_return_offpeak_daily
    source: sensor.dsmr_reading_electricity_returned_1
    cycle: daily
  daily_energy_returned_peak:
    name: "Energy return peak (daily)"
    unique_id: energy_return_peak_daily
    source: sensor.dsmr_reading_electricity_returned_2
    cycle: daily

  # Calculations per month
  monthly_energy_delivered_offpeak:
    name: "Energy usage offpeak (monthly)"
    unique_id: energy_usage_offpeak_monthly
    source: sensor.dsmr_reading_electricity_delivered_1
    cycle: monthly
  monthly_energy_delivered_peak:
    name: "Energy usage peak (monthly)"
    unique_id: energy_usage_peak_monthly
    source: sensor.dsmr_reading_electricity_delivered_2
    cycle: monthly

  monthly_energy_returned_offpeak:
    name: "Energy return offpeak (monthly)"
    unique_id: energy_return_offpeak_monthly
    source: sensor.dsmr_reading_electricity_returned_1
    cycle: monthly
  monthly_energy_returned_peak:
    name: "Energy return peak (monthly)"
    unique_id: energy_return_peak_monthly
    source: sensor.dsmr_reading_electricity_returned_2
    cycle: monthly

template:
  - sensor:
      # Calculations per period
      - name: "Daily Energy Delivered"
        default_entity_id: sensor.daily_energy_delivered
        unit_of_measurement: kWh
        state: "{{ (states('sensor.daily_energy_delivered_offpeak') | float(0) + states('sensor.daily_energy_delivered_peak') | float(0)) | round(2) }}"

      - name: "Monthly Energy Delivered"
        default_entity_id: sensor.monthly_energy_delivered
        unit_of_measurement: kWh
        state: "{{ (states('sensor.monthly_energy_delivered_offpeak') | float(0) + states('sensor.monthly_energy_delivered_peak') | float(0)) | round(2) }}"

      - name: "Daily Energy Returned"
        default_entity_id: sensor.daily_energy_returned
        unit_of_measurement: kWh
        state: "{{ (states('sensor.daily_energy_returned_offpeak') | float(0) + states('sensor.daily_energy_returned_peak') | float(0)) | round(2) }}"

      - name: "Monthly Energy Returned"
        default_entity_id: sensor.monthly_energy_returned
        unit_of_measurement: kWh
        state: "{{ (states('sensor.monthly_energy_returned_offpeak') | float(0) + states('sensor.monthly_energy_returned_peak') | float(0)) | round(2) }}"

      - name: "Hourly Energy Returned"
        default_entity_id: sensor.hourly_energy_returned
        unit_of_measurement: kWh
        state: "{{ (states('sensor.hourly_energy_returned_offpeak') | float(0) + states('sensor.hourly_energy_returned_peak') | float(0)) | round(2) }}"

      # Current power sensors
      - name: "Current Energy usage"
        default_entity_id: sensor.currently_energy_delivered_watt
        unit_of_measurement: W
        state: "{{ (states('sensor.dsmr_reading_electricity_currently_delivered') | float(0) * 1000) | round(0) | round(2) }}"

      - name: "Current Energy return"
        default_entity_id: sensor.currently_energy_returned_watt
        unit_of_measurement: W
        state: "{{ (states('sensor.dsmr_reading_electricity_currently_returned') | float(0) * 1000) | round(0) | round(2) }}"

      # Correction to current power sensors
      - name: "Power Usage L1"
        default_entity_id: sensor.currently_power_usage_l1_watt
        unique_id: smartmeter_power_usage_l1_watt
        device_class: power
        unit_of_measurement: W
        state: "{{ states('sensor.dsmr_reading_phase_currently_delivered_l1') | float(0) | round(0) }}"

      - name: "Power Usage L2"
        default_entity_id: sensor.currently_power_usage_l2_watt
        unique_id: smartmeter_power_usage_l2_watt
        device_class: power
        unit_of_measurement: W
        state: "{{ states('sensor.dsmr_reading_phase_currently_delivered_l2') | float(0) | round(0) }}"

      - name: "Power Usage L3"
        default_entity_id: sensor.currently_power_usage_l3_watt
        unique_id: smartmeter_power_usage_l3_watt
        device_class: power
        unit_of_measurement: W
        state: "{{ states('sensor.dsmr_reading_phase_currently_delivered_l3') | float(0) | round(0) }}"

      - name: "Power Return L1"
        default_entity_id: sensor.currently_power_return_l1_watt
        unique_id: smartmeter_power_return_l1_watt
        device_class: power
        unit_of_measurement: W
        state: "{{ states('sensor.dsmr_reading_phase_currently_returned_l1') | float(0) | round(0) }}"

      - name: "Power Return L2"
        default_entity_id: sensor.currently_power_return_l2_watt
        unique_id: smartmeter_power_return_l2_watt
        device_class: power
        unit_of_measurement: W
        state: "{{ states('sensor.dsmr_reading_phase_currently_returned_l2') | float(0) | round(0) }}"

      - name: "Power Return L3"
        default_entity_id: sensor.currently_power_return_l3_watt
        unique_id: smartmeter_power_return_l3_watt
        device_class: power
        unit_of_measurement: W
        state: "{{ states('sensor.dsmr_reading_phase_currently_returned_l3') | float(0) | round(0) }}"

  - binary_sensor:
      - name: "Smartmeter connectivity status"
        state: "{{ now() - states.sensor.smartmeter_wifi_signal_strength_rssi.last_changed < timedelta(minutes=10) }}"
        device_class: connectivity
